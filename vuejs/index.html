<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Test KC</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="http://localhost:8181/auth/js/keycloak.js"></script>
</head>

<body>
    <div id="app">
        <button v-on:click="authenticate">Get token ...</button>
        <p>{{ token }}</p>
        <button v-on:click="onClick">Test services ...</button>
        <div  style="border: thick double black;">
        <span>Access to a secured resource by role "test"</span>
        <p>/rest/secured/api => {{ secured }}</p>
        </div>
        <div style="border: thick double red;">
        <span>Access to a secured resource by role "test2"</span>
        <p >/rest/secured/api2 => {{ secured2 }}</p>
        </div>
        <div style="border: thick double green;">
        <span>Access to a not secured resource </span>
        <p >/rest/open => {{ open }}</p>
        </div>
    </div>

    <script>
        const keycloakURL ="http://localhost:8181/auth";

        const testKcSecured = "http://localhost:8383/rest/secured/api";
        const testKcSecured2 = "http://localhost:8383/rest/secured/api2";
        const testKcOpen = "http://localhost:8383/rest/open";

        const keycloakParams = {
            url: keycloakURL,
            realm: "Test",
            clientId: "IHM"
        };
        const keycloak = Keycloak( keycloakParams );

        const v = new Vue( {
            el: '#app',
            data: {
                secured: "NOP",
                secured2: "NOP",
                open: "Nop",
                token: "No Token"
            },
            methods: {
                onClick() {
                    axios.get( testKcSecured ).then( response => ( this.secured = response.data ) );
                    axios.get( testKcSecured2 ).then( response => ( this.secured2 = response.data ) );
                    axios.get( testKcOpen ).then( response => ( this.open = response.data ) )
                },
                authenticate() {
                    console.log( "authenticate ", keycloakParams );
                    keycloak
                        .init( { onLoad: "login-required", checkLoginIframe: false } )
                        .then( auth => {
                            if ( auth ) {
                                console.log( "authenticated", keycloak );
                                this.token = keycloak.token;
                                console.log( "setTimeout" );
                                setTimeout( () => {
                                    console.log( "timeout ended, launch keycloack.updateToken" );
                                    keycloak
                                        .updateToken( 70 )
                                        .then( refreshed => {
                                            if ( refreshed ) {
                                                console.log( "TOKEN_REFRESHED" );
                                            } else {
                                                console.log(
                                                    "TOKEN_VALID_FOR",
                                                    Math.round(
                                                        keycloak.tokenParsed.exp +
                                                        keycloak.timeSkew -
                                                        new Date().getTime() / 1000
                                                    )
                                                );
                                            }
                                        } )
                                        .catch( () => {
                                            console.log( "TOKEN NOT REFRESHED" );
                                        } );
                                }, 60000 );
                            } else {
                                console.log( "NOT authenticated" );
                                this.token = "No Token"
                            }
                        } )
                        .catch( () => {
                            console.log( "catch ...", keycloak );

                            this.token = "No Token"
                        } );
                }
            }
        })
    </script>
</body>

</html>